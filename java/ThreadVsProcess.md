# 스레드 vs 프로세스 (context-switching)

**updated 2023.03.13**

- CPU, 코어, 프로세스, 쓰레드 관계
- 스레드 갯수가 CPU코어 갯수보다 많아지면 어떤 일이 벌어지는지

## 정의

### 스레드 (Thread) 란?

- 실, 흐름
- 프로세스 내에서 실행되는 흐름의 단위를 말한다.
- 경량 프로세스 라고도 한다.

### 프로세스 (Process) 란?

- 운영체제에서 실행중인 하나의 애플리케이션을 말한다.
- 실행시 운영체제로부터 메모리를 할당받아 코드를 실행한다.

## 멀티 프로세스 와 멀티 스레드 비교

- 멀티프로세스에서 각 프로세스는 독립적으로 실행되며 각각 별개의 메모리를 차지하고 있는 것과 달리
- 멀티스레드는 프로세스 내의 메모리를 공유해 사용할 수 있다. 또한 프로세스 간의 전환 속도보다 스레드 간의 전환 속도가 빠르다.
  - 멀티스레드의 다른 장점은 CPU가 여러 개일 경우에 각각의 CPU가 스레드 하나씩을 담당하는 방법으로 속도를 높일 수 있다는 것이다. 이러한 시스템에서는 여러 스레드가 실제 시간상으로 동시에 수행될 수 있기 때문이다.
  - 멀티스레드의 단점에는 각각의 스레드 중 어떤 것이 먼저 실행될지 그 순서를 알 수 없다는 것이 있다.

## CPU, 코어, 프로세스, 쓰레드 관계

### [CPU (central processing unit)](https://ko.wikipedia.org/wiki/%EC%A4%91%EC%95%99_%EC%B2%98%EB%A6%AC_%EC%9E%A5%EC%B9%98)

- 컴퓨터의 두뇌에 해당
- 컴퓨터 시스템을 통제하고 프로그램의 연산을 실행 · 처리하는 가장 핵심적인 컴퓨터의 제어 장치

### 코어

- 중앙 처리 장치안(CPU)의 코어의 수로도 성능의 차이가 난다.
- 코어는 중앙 처리 장치의 역할을 하는 블록으로 예전에는 한 개의 칩 안에는 한 개의 코어의 구조를 가진 싱글코어가 다수였지만 최근에는 한 개의 칩 안에 여러 개의 코어를 가지는 멀티코어 구조를 채택하고 있다.
  - 싱글 코어(Single Core)는 하나의 코어로 이루어진 CPU이다. 일반적으로 멀티 코어에 비해 경비가 싸고 프로그래밍도 간단하지만 보수 작업이나 고장의 경우에는 시스템이 완전히 멈추고 수많은 작업을 잘 분산시키지 못해 멀티 코어에 비해 처리 속도가 느리다는 단점이 있다.
  - 멀티 코어(Multi Core)는 한 개의 칩 안에 여러 개의 연산을 처리할 수 있는 장치를 병렬적으로 연결한 시스템을 통하여 더 좋은 성능의 중앙 처리 장치를 얻을 수 있게 된다. 하지만 프로그램을 작성할 때 멀티코어를 활용할 수 있도록 코딩해야 한다. 그렇지 않으면 멀티코어 CPU라도 멀티코어를 활용 못할 수 있다.

### CPU, 코어, 프로세스, 쓰레드 관계

- CPU는 중앙처리장치로 최소 1개 이상의 코어를 갖고 있다.
- CPU의 코어는 중앙처리장치 역활을 하는 (실제 업무를 수행하는) 요소 (블록)으로 코어가 많을 수 록 동시에 여러 일을 처리 할 수 있다.
- CPU에서 처리하는 업무는 프로세스를 실행하는 것으로, 결과적으로 프로세스 안의 스레드를 실행한다.
- 멀티태스킹을 위해서 각각의 CPU 코어에서는 메모리에 올라온 프로세스들을 순차적으로 돌아가면서 실행한다.
  - 실행중인 프로세스가 변경될 때, CPU 코어 내 메모리 공간인 레지스터에 작업할 프로세스의 주소값으로 변경하고,
  - 이전 프로세스의 PCB에는 현재까지 작업한 내용을 기록하여 다시 해당 프로세스 차례가 되었을 때, 중단된 지점부터 다시 일을 할 수 있도록 한다.

<img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FmlFSV%2Fbtq44O3jOiZ%2F4f1Arc048UHdYBjQhJnvQ0%2Fimg.png" />

- 멀티 프로세스 vs 멀티 스레드

  - 기본적으로 프로세스는 독립된 메모리공간을 사용하기 때문에, 프로세스 간에 자원을 공유하지 않으나,
  - 스레드는 프로세스 안에서 실행 되기 때문에, 그 안에서 자원을 공유한다. (정확히는 공유자원 Code, Data, Heap이 있음)
    <img src="https://velog.velcdn.com/images%2Fcrosstar1228%2Fpost%2Fd4b71745-9842-4072-9222-f2914480cdfd%2Fimage.png"/>
  - 결과적으로 CPU 코어 입장에서, 실행할 업무가 변경 되었을 때, 프로세스 단위의 컨텍스트 스위칭 보다, 스레드 단위의 컨텍스트 스위칭이 훨씬 더 가벼워 빠르게 업무를 처리할 수 있다.
    - 예를 들자면, 코어 입장에서 브라우저 프로세스를 처리하다 계산기 프로세스로 변경을 해야하는 경우, 위 구조에 보이듯 캐시 메모리에 계산기 프로세스와 관련된 정보를 모두 메모리에 불러오고 레지스터에도 계산기 프로세스와 관련된 주소값을 저장해야한다.
    - 만약 코어 입장에서 스레드 단위로 업무를 처리할 때, 브라우저 프로세스안에서 클릭이벤트 스레드와, 유투브 음악 재생 스레드가 있고, 계산기 프로세스의 클릭이벤트 스레드가 있다고 가정 할 때,
      브라우저 클릭이벤트를 처리하다 계산기 클릭이벤트를 처리하고 다시 유투브 음악 재생 스레드를 처리한다고 하더라도 브라우저 간에는 자원을 공유 함으로, cpu 내부에 캐시해야할 정보가 상대적으로 줄어들어 프로세스보다는 낮은 비용의 컨텍스트 스위칭이 발생한다고 볼 수 있다.

- 관계 요약
  - CPU = 중앙처리 장치를 통으로 부르는 말 => 회사의 부서
  - 코어 = 중앙처리 장치 블록으로 실제 업무를함 => 부서에 속한 근무자
  - 프로세스 = 중앙처리 장치에서 다루는 업무 단위 => 해당 부서의 진행중인 프로젝트
  - 스레드 = 코어 블록에서 실제로 수행하는 업무 단위 => 근무자가 지금 당장 처리해야 할 업무액션 (보고서 작성, 자료 복사 등등 )
  - 컨텍스트 스위칭 = 근무자 입장에서 할 일(스레드) 또는 프로젝트 (프로세스)가 변경이 되었을 때, 머릿속에서 해당 업무와 관련된 정보를 불러오는 작업. => 한 프로젝트내 할 일이 변경되는 것 보다, 프로젝트 자체가 바뀌면 머릿속에 지난 업무내용을 불러오는 시간이 더 걸림.

## 스레드 갯수가 CPU 코어 갯수보다 많아지면 어떤 일이 벌어지는지

- 관계 요약을 통해 비유 하자면
  - 부서의 근무자 수 보다, 해야할 업무가 많으면 어떤일이 벌어지느냐 인데, 결과적으로 한 사람이 여러 일을 맡게 된다.
- 컴퓨터입장에서 볼 때는 CPU 코어에서 동시에 여러 일을 다뤄야함으로 컨텍스트 스위칭이 발생한다.

- 실제로 멀티 코어 환경에서는, 코어 갯수 이하로 프로세스(또는 스레드)가 실행되면, 각 코어에서 업무를 맡아서 병렬로 처리한다.
- 단, 실행해야할 프로세스 (스레드) 갯수가 코어 갯수를 초과하면, 각각의 코어는 사용자에게 동시에 모든 프로그램이 실행중인 것 처럼 느끼게 하기위해 = 즉 '동시성'을 위해 여러가지 프로세스(스레드)의 업무를 짧은 텀으로 진행하며 전환한다. (컨텍스트 스위칭의 발생)

참고자료

- [CPU 구조](https://hwannny.tistory.com/96)
- [[CS]프로세스와 쓰레드, 멀티프로세스와 멀티쓰레드](https://velog.io/@crosstar1228/CS%ED%94%84%EB%A1%9C%EC%84%B8%EC%8A%A4%EC%99%80-%EC%93%B0%EB%A0%88%EB%93%9C-%EB%A9%80%ED%8B%B0%ED%94%84%EB%A1%9C%EC%84%B8%EC%8A%A4%EC%99%80-%EB%A9%80%ED%8B%B0%EC%93%B0%EB%A0%88%EB%93%9C%EB%A9%80%ED%8B%B0%EC%BD%94%EC%96%B4)

# 세션 불일치 현상 해결방법

**updated 2023.04.10**

## 세션 불일치 현상이란?

Scale Out으로 서버를 확장할 때, 다중 서버 환경에서 생길 수 있는 세션의 불일치 현상을 말한다.

세션은 서버의 메모리(RAM)에 저장되기 때문에, 기본적으로 서버간의 공유가 불가 하다.

<img src="https://hudi.blog/static/6857601e14a226b6adde9eb430935f41/ca1dc/session-consistency-issue.png"/>

> 로드 밸런서가 유저의 요청이 들어올 때 마다 A → B → C → A … 순서대로 요청을 분산하는 (라운드 로빈) 상황 예시 그림.

출처 [다중 서버 환경에서의 세션 불일치 문제와 해결방법](https://hudi.blog/session-consistency-issue/)

## 해결방법

1. Sticky Session

   <img src="https://hudi.blog/static/49d599e8110f844dea2d5fe64cd172b1/ca1dc/sticky-session.png"/>

   - Sticky Session은 이름 처럼 세션과 세션을 맺은 서버가 달라붙어있는 상태라 생각할 수 있다. 즉 클라이언트의 요청이 항상 해당 클라이언트와 세션을 맺은 서버로 전달되는 방식이다.

   - 세션 정보가 없는 사용자가 서버에 요청을 하면, 로드밸런서의 기본 알고리즘 대로 서버에 요청을 전달하고 세션을 맺는다. 이때부터 이 클라이언트의 요청은 세션을 맺은 서버로 고정되어 전달 된다.

   - Sticky Session을 구현하는 방법은 쿠키를 통해 연결된 세션 서버의 정보를 파악하거나, 클라이언트의 IP를 확인하여 판별하는 방법이 있다.

   - 단점

     - 특정 서버에만 트래픽이 집중될 위험이 있다. 로드 밸런서의 목적은 트래픽을 적절히 분산 시키는 것인데, Sticky Session으로 인해 특정 서버에만 요청이 몰릴 수 있어 로드밸런싱의 사용이 무의미해 질 수 있다.

     - 하나의 서버에 장애가 발생하면, 해당 서버에 저장된 세션 정보를 모두 잃게 된다. 이 경우 사용자는 재 로그인을 해야 한다. 이는 가용성의 문제를 뜻한다.

2. Session Clustering

   <img src="https://hudi.blog/static/f94df6ab4c0ec0175d307d03d5f475f6/44038/session-clustering.png"/>

   - Session Clustering이란 세션의 군집화(여러개가 무리지음)란 의미에서 동일한 내용의 세션이 동시에 여러개 생성(각 서버에 세션이 생성)된다고 이해할 수 있다.

   - 즉 특정 서버에서 세션이 생성될 때, 다른 서버로 세션을 전파 및 복제 하는 방식으로 문제를 해결한다. 이를 통해 Sticky Session의 한계를 해결할 수 있다. (특정 서버에 부하가 몰리거나, 장애 발생시 가용성 이슈)

   - 단점 (특히 대규모 클러스터환경)

     - 메모리 사용이 비효율 적이다. 모든 서버에서 세션을 복제하여 갖고 있기 때문에 효율적이지 않다.

     - 세션 생성시 데이터를 다른 서버로 전달하기 위해 Sticky Session보다 많은 네트워크 통신을 하게된다.

     - 또한 세션을 전달받고 복제하는 동안의 시간차로 인해 세션 불일치 이슈가 발생할 가능성이 있다. (예를 들어 A서버에서 생성된 세션이 B서버로는 전파가 되었지만, 아직 C서버로 전파가 되지 않았을 찰나에 클라이언트가 C서버로 요청할 수도 있는 것 이다.)

3. 세션 스토리지 분리 (Session Server, DB등을 활용)

   <img src="https://hudi.blog/static/802d972eb644eca74848421de0b51696/9e707/session-storage.png"/>

   - 세션스토리지를 외부 서버로 분리하는 방식이다.

     - 세션만 맺고 그 정보를 저장하는 서버를 두는 방식으로, 그 정보를 어디에 저장하느냐에 따라 구현 방식이 달라진다.
     - 일반적으로 세션은 입출력이 잦은 업무임으로, DB를 사용 하여 관리할 경우
       - Disk-Based DB (ex. Mysql, postgreSQL, MongoDB 기본설정값) 보다는
       - In-Memory DB를 사용하는 것이 일반 적이다.
         - Disk-Based DB 보다 빠른 쓰기/읽기가 가능하며
         - 세션정보는 영속성을 보장할 필요가 없는 정보기 때문이다. (일정기간이 지나면 소멸시키는 데이터이며, 유실시 피해가 다른 데이터와 달리 크지 않음)
           > 세션 데이터는 Key-Value로 구성되어있기 때문에, In-Memory DB중 대표적인 Key-Value Store형식인 Redis, Memcashed를 사용한다.

   - 세션 스토리지를 분리하면 Sticky Session과 Session Clustering의 단점을 모두 보완가능하다

   - 한계
     - 하나뿐인 세션 스토리지 서버에 장애가 발생시 모든 서버가 세션 데이터를 정상적으로 사용할 수 없게 된다.
     - 이에 대한 해결 방법은 여러개의 세션 스토리지 서버를 구성하는 것이다.

## 더 나아가기

- 세션 불일치 처럼, 다중 서버환경에서 발생할 수 있는 다른 이슈는 무엇이 있는가?
  - 서버별 캐싱된 데이터의 불일치 현상
  - DB 트랜잭션 관리
  - 트래픽 분산

참고 [다중 서버 환경에서의 세션 불일치 문제와 해결방법](https://hudi.blog/session-consistency-issue/)
